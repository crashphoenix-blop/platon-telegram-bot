# Анализатор расхода топлива

Программа для автоматического подсчета расхода топлива по автомобилям на основе данных из системы Крассула (топливные карты) и ГЛОНАСС.

## Возможности

- ✅ Загрузка данных из Excel файлов Крассулы и ГЛОНАСС
- ✅ Автоматическое сопоставление заправок между системами
- ✅ Расчет расхода топлива по формуле: `(литры / пробег) * 100`
- ✅ Обнаружение несоответствий и аномалий
- ✅ Учет сливов топлива
- ✅ Генерация подробных Excel отчетов
- ✅ Система уведомлений о проблемах
- ✅ Настраиваемые параметры анализа

## Установка

1. Установите Python 3.7 или выше
2. Установите зависимости:
```bash
pip install -r requirements.txt
```

## Использование

### Быстрый старт

1. Запустите программу:
```bash
python run_fuel_analysis.py
```

2. Следуйте инструкциям программы:
   - Укажите путь к файлу Крассулы
   - Укажите путь к файлу ГЛОНАСС
   - Настройте соответствие карт и автомобилей
   - Получите готовый отчет

### Программное использование

```python
from fuel_consumption_analyzer import FuelConsumptionAnalyzer

# Создаем анализатор
analyzer = FuelConsumptionAnalyzer()

# Загружаем данные
analyzer.load_krassula_data("путь_к_файлу_крассулы.xlsx")
analyzer.load_glonass_data("путь_к_файлу_глонасс.xlsx")

# Настраиваем соответствие карт и автомобилей
card_mapping = {
    "0249": "497",  # карта 0249 -> автомобиль 497
    "1234": "203",  # карта 1234 -> автомобиль 203
}
analyzer.load_card_mapping(card_mapping)

# Выполняем анализ
analyzer.match_refuels()
analyzer.calculate_fuel_consumption()

# Создаем отчет
analyzer.generate_excel_report("отчет.xlsx")
analyzer.print_notifications()
```

## Структура данных

### Файл Крассулы (топливные карты)

Обязательные колонки:
- `Дата и время` - дата и время транзакции
- `Коментарий` - комментарий с номером карты
- `Товар` - вид топлива
- `Кол-во литров` - количество литров
- `Цена со скидкой` - цена за литр
- `Сумма со скидкой` - общая сумма

### Файл ГЛОНАСС

Должен содержать листы:
- `Заправки и зарядки батареи` - данные о заправках
- `Сливы` - данные о сливах топлива

Обязательные колонки в листе заправок:
- `Группировка` - марка и ГРЗ автомобиля
- `Дата` - дата заправки
- `Время` - время заправки
- `Пробег` - пробег на момент заправки
- `Заправлено` - количество заправленного топлива

## Алгоритм работы

1. **Загрузка данных** - программа читает Excel файлы из обеих систем
2. **Извлечение номеров** - извлекает номера автомобилей из данных ГЛОНАСС
3. **Сопоставление** - находит соответствующие заправки в обеих системах
4. **Расчет расхода** - вычисляет расход по формуле: `(литры / пробег) * 100`
5. **Валидация** - проверяет данные на аномалии и несоответствия
6. **Отчет** - создает Excel файл с результатами

## Настройки

Все настройки находятся в файле `config.py`:

- `max_time_diff_hours` - максимальное время между заправками для сопоставления
- `max_liters_diff_percent` - максимальная разница в литрах для сопоставления
- `min_distance_km` - минимальный пробег для расчета расхода
- `max_dut_error_liters` - максимальная погрешность ДУТ

## Уведомления

Программа генерирует уведомления о:

- Заправках, найденных только в Крассуле
- Заправках, найденных только в ГЛОНАСС
- Сливах топлива
- Аномальных значениях расхода
- Погрешностях датчиков

## Структура отчета

Excel файл содержит листы:

1. **Основные данные** - все заправки с расчетами
2. **Уведомления** - список проблем и аномалий
3. **Сливы** - данные о сливах топлива

## Примеры использования

### Пример 1: Базовый анализ
```python
python example_usage.py
```

### Пример 2: Обработка конкретных файлов
```python
from fuel_consumption_analyzer import FuelConsumptionAnalyzer

analyzer = FuelConsumptionAnalyzer()
analyzer.load_krassula_data("топливо/отчет_транзакций.xlsx")
analyzer.load_glonass_data("топливо/отчет_глонасс.xlsx")
# ... остальной код
```

## Логирование

Программа ведет подробные логи в файле `fuel_analysis.log`:
- Информация о загрузке данных
- Процесс сопоставления заправок
- Ошибки и предупреждения
- Статистика анализа

## Требования

- Python 3.7+
- pandas >= 1.5.0
- numpy >= 1.21.0
- openpyxl >= 3.0.0
- xlrd >= 2.0.0

## Поддержка

При возникновении проблем:

1. Проверьте формат входных файлов
2. Убедитесь в правильности соответствия карт и автомобилей
3. Проверьте логи в файле `fuel_analysis.log`
4. Убедитесь, что все зависимости установлены

## Версия

v1.0.0 - Первая версия с базовым функционалом
